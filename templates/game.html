<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Flask-SocketIO Test</title>
		<script type="text/javascript" src="//code.jquery.com/jquery-1.4.2.min.js"></script>
		<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.5/socket.io.min.js"></script>
		<script type="text/javascript" src= "/js/client.js"></script>
		<script type="text/javascript" src= "/js/phaser.js"></script>
		<script type="text/javascript" charset="utf-8">

/*
		All handlers and callbacks must be in this file
		No exposure to other files
*/

			/********************************************
			*											*
			*		rendering window sizing  			*
			*											*
			********************************************/		
		
			$(window).resize(function() { window.resizeGame(); } );
			
			function resizeGame() {
				var height = $(window).height();
				var width = $(window).width();
				game.width = window.innerWidth;
				game.height = window.innerHeight;
				game.stage.bounds.width = width;
				game.stage.bounds.height = height;
				if (game.renderType === Phaser.WEBGL){ 
					game.renderer.resize(width, height);
				}
			}
			
			var game; 
		
			
			$(document).ready(function(){
				console.log("4 four");
				game = new Phaser.Game(window.innerWidth, window.innerHeight, Phaser.AUTO, 'talktown', { preload: preload, create: create, update: update });

				namespace = '/gameplay'; 
				var socket = io.connect('http://' + document.domain + ':' + location.port + namespace);
				var ready = false;
				
				// event handler for returned game world info from server
				/*socket.on('return info', function(msg) {
					$('#log').append('<br>' + $('<div/>').text('Received #' + msg.count + ': JS received some info about: ' + msg.data).html());
				});
				
				// handler for posting a message
				// these send data to the server in a variety of ways
				$('form#emit').submit(function(event) {
					console.log("JAVASCRIPT: User wants to post this message: " + $('#emit_data').val());
					socket.emit('my event', {data: $('#emit_data').val()});
					return false;
				}); */
				
				
				/********************************************
				*	recieve json dict of lots				*
				********************************************/
				socket.on('return lots', function(msg) {
					parseLotsJson(msg.data);
		
				});
				
				/********************************************
				*	recieve json dict of blocks				*
				********************************************/
				socket.on('return blocks', function(msg) {
					parseBlocksJson(msg.data);
		
				});
				
				/********************************************
				*	python server will return			 	*
				*	true if world finished generating		*
				********************************************/
				socket.on('ready response', function(msg) {
					if(msg.data == "True") 
						ready = true;
				});
				
				
				
				/********************************************
				*	change the view when gen finished    	*
				********************************************/
				socket.on('redirect', function (data) {
					window.location = data.url;
				});
				
			

				/********************************************
				*	Get information about generated world	*
				********************************************/
				function requestWorldInfo() {
					console.log("requestWorldInfo");
					socket.emit('get_random_person', {data: 'random person'});
					socket.emit('get_city_name', {data: 'city name'});
					socket.emit('get_lot_json', {data: '0'});
					socket.emit('get_block_json', {data: '0'});
				}
				
				
				requestWorldInfo();
				
		
				
				/*function checkPreloadReady() {
					if (!preloadReady) {
							window.setTimeout(checkPreloadReady, 1000);
							console.log("Called checkPreloadReady(), !ready");	
					} else {
							//call this only when preloading is done
							console.log("preload is ready");
							requestWorldInfo();
					}
				}
				
				
				
				function newGame() { 
					game = new Phaser.Game(window.innerWidth, window.innerHeight, Phaser.AUTO, 'talktown', { preload: preload, create: create, update: update });
					requestWorldInfo();
					//checkPreloadReady();
				}
				*/
				
				
				/********************************************
				*	keep checking that world is generated	*
				********************************************/ 
				// comment out checkready and uncomment requestworldinfo()
				// if redirecting ^
				
				/*function checkReady() {
					socket.emit('ready');
					if (!ready) {
						window.setTimeout(checkReady, 1000);
						console.log("Called checkReady(), !ready");
					} else {
						console.log("world is ready");
						//newGame();
						//game = new Phaser.Game(window.innerWidth, window.innerHeight, Phaser.AUTO, 'talktown', { preload: preload, create: create, update: update });
						requestWorldInfo();
					}
				}
				checkReady();*/
			});
			
			//requestWorldInfo();
			
		</script>
	</head>
	<body style = "padding:0px;margin:0px">
		<div id = "talktown" style="offset:0;width:100%;height:100%;margin:0;padding:0"></div>
		<!--<body>
			<h1>Flask-SocketIO Test</h1>
			<h2>Send:</h2>
			<form id="emit" method="POST" action='#'>
				<input type="text" name="emit_data" id="emit_data" placeholder="Message">
				<input type="submit" value="Send a message">
			</form>
			<form id="disconnect" method="POST" action="#">
				<input type="submit" value="Disconnect">
			</form>
			<h2>Receive:</h2>
			<div id="log"></div>
		-->
	</body>
</html>
